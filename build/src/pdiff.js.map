{"version":3,"sources":["../../src/pdiff.js"],"names":["createDiffer","basePNG","width","height","differ","comparisonPNG","writeDiffFile","diffFilePath","diffPNG","diffSize","data","threshold","pack","pipe","createWriteStream"],"mappings":";;;;;kBAMwBA,Y;;AALxB;;;;AACA;;;;AACA;;AACA;;;;;;AAEe,SAASA,YAAT,CAAuBC,OAAvB,EAC0E;AACvF,SAAO,0CAAG;AAAA;AAAA;AAAA;AAAA;AAAA;AACR;AACQC,iBAFA,GAEkBD,OAFlB,CAEAC,KAFA,EAEOC,MAFP,GAEkBF,OAFlB,CAEOE,MAFP;;AAIR;;;;;AAIMC,kBARE,GAQO,SAATA,MAAS,CAACC,aAAD,EAA6E;AAAA,kBAAxDC,aAAwD,uEAAxC,KAAwC;AAAA,kBAAjCC,YAAiC;;AAC1F,kBAAMC,UAAUF,gBAAgB,eAAQ,EAAEJ,YAAF,EAASC,cAAT,EAAR,CAAhB,GAA6C,IAA7D;;AAEA,kBAAMM,WAAmB,0BAAWR,QAAQS,IAAnB,EAAyBL,cAAcK,IAAvC,EAA6CF,WAAWA,QAAQE,IAAhE,EAAsER,KAAtE,EAA6EC,MAA7E,EAAqF,EAAEQ,WAAW,GAAb,EAArF,CAAzB;;AAEA;AACA,kBAAIL,aAAJ,EAAmB;AACjBE,wBAAQI,IAAR,GAAeC,IAAf,CAAoB,aAAGC,iBAAH,CAAqBP,YAArB,CAApB;AACD;;AAED,qBAAOE,QAAP;AACD,aAnBO;;AAAA,6CAqBDL,MArBC;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH,EAAP;AAuBD","file":"pdiff.js","sourcesContent":["// @flow\nimport fs from 'fs';\nimport co from 'co';\nimport { PNG } from 'pngjs';\nimport pixelmatch from 'pixelmatch';\n\nexport default function createDiffer (basePNG: PNG):\n  Promise<(comparisonPNG: PNG, writeDiffFile: boolean, diffFilePath?: string) => number> {\n  return co(function* () {\n    // Get the width and height for the base PNG dimensions.\n    const { width, height } = basePNG;\n\n    /**\n     * Differ function. Basically a partial application of the Pixelmatch\n     * diff algorithm, with a closure around the base image.\n     */\n    const differ = (comparisonPNG: PNG, writeDiffFile = false, diffFilePath: string): number => {\n      const diffPNG = writeDiffFile ? new PNG({ width, height }) : null;\n\n      const diffSize: number = pixelmatch(basePNG.data, comparisonPNG.data, diffPNG && diffPNG.data, width, height, { threshold: 0.2 });\n\n      // Optionally write the diff image to disk.\n      if (writeDiffFile) {\n        diffPNG.pack().pipe(fs.createWriteStream(diffFilePath));\n      }\n\n      return diffSize;\n    };\n\n    return differ;\n  });\n}\n"]}